<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gerenciador de Tarefas Java</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .concluido {
            text-decoration: line-through;
            color: gray;
        }
        .btn-acao { width: 120px; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h1 class="text-center mb-4">Minhas Tarefas (Spring Boot)</h1>

    <!-- Formulário de Cadastro -->
    <div class="card p-4 mb-4 shadow-sm">
        <form action="/add" method="POST" class="d-flex gap-2">
            <input type="text" name="titulo" class="form-control" placeholder="Nova tarefa..." required>
            <button type="submit" class="btn btn-primary">Adicionar</button>
        </form>
    </div>

    <!-- Lista de Tarefas -->
    <div class="card shadow-sm">
        <ul class="list-group list-group-flush">

            <!-- Loop Thymeleaf: th:each -->
            <li th:each="tarefa : ${tarefas}" class="list-group-item d-flex justify-content-between align-items-center">

                <!-- Texto da Tarefa (Aplica classe 'concluido' condicionalmente) -->
                <span th:id="'texto-' + ${tarefa.id}"
                      th:text="${tarefa.titulo}"
                      th:classappend="${tarefa.status == 'concluído'} ? 'concluido' : ''">
                        Nome da Tarefa
                    </span>

                <div class="btn-group">
                    <!-- Botão REST (AJAX) -->
                    <button th:onclick="'alternarStatus(' + ${tarefa.id} + ')'"
                            th:id="'btn-' + ${tarefa.id}"
                            th:text="${tarefa.status == 'pendente' ? 'Concluir' : 'Reabrir'}"
                            th:class="'btn btn-sm btn-acao ' + (${tarefa.status == 'pendente'} ? 'btn-success' : 'btn-secondary')">
                        Ação
                    </button>

                    <!-- Botão Excluir -->
                    <a th:href="@{/delete/{id}(id=${tarefa.id})}" class="btn btn-sm btn-danger">Excluir</a>
                </div>
            </li>

            <!-- Caso lista vazia -->
            <li th:if="${tarefas.empty}" class="list-group-item text-center text-muted">
                Nenhuma tarefa cadastrada.
            </li>
        </ul>
    </div>
</div>

<script>
    function alternarStatus(id) {
        fetch(`/api/toggle/${id}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const texto = document.getElementById(`texto-${id}`);
                    const btn = document.getElementById(`btn-${id}`);

                    if (data.novo_status === 'concluído') {
                        texto.classList.add('concluido');
                        btn.textContent = 'Reabrir';
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-secondary');
                    } else {
                        texto.classList.remove('concluido');
                        btn.textContent = 'Concluir';
                        btn.classList.remove('btn-secondary');
                        btn.classList.add('btn-success');
                    }
                }
            })
            .catch(error => console.error('Erro:', error));
    }
</script>

</body>
</html>